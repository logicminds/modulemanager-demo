<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Design - Voxpupuli Module Manager</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/marked@12.0.0/marked.min.js"></script>
    <style>
        .design-layout {
            display: flex;
            gap: 2rem;
            max-width: 1400px;
            margin: 0 auto;
            align-items: flex-start;
        }

        .toc-sidebar {
            width: 280px;
            flex-shrink: 0;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            padding: 1.5rem;
            position: sticky;
            top: 100px; /* Navbar height + margin */
            max-height: calc(100vh - 120px);
            overflow-y: auto;
        }

        .toc-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text);
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .toc-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .toc-list li {
            margin-bottom: 0.25rem;
        }

        .toc-item {
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .toc-toggle {
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            font-size: 0.875rem;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            transition: color 0.2s;
            flex-shrink: 0;
        }

        .toc-toggle:hover {
            color: var(--primary);
        }

        .toc-toggle::before {
            content: '[-]';
            font-family: monospace;
            font-size: 0.75rem;
            line-height: 1;
        }

        .toc-toggle.collapsed::before {
            content: '[+]';
        }

        .toc-toggle.expanded::before {
            content: '[-]';
        }

        .toc-list a {
            display: block;
            padding: 0.375rem 0.5rem;
            color: var(--text-light);
            text-decoration: none;
            border-radius: 6px;
            transition: all 0.2s;
            font-size: 0.875rem;
            line-height: 1.5;
            flex: 1;
        }

        .toc-list a:hover {
            background: var(--bg);
            color: var(--primary);
        }

        .toc-list a.active {
            background: rgba(37, 99, 235, 0.1);
            color: var(--primary);
            font-weight: 500;
        }

        .toc-list .toc-h1 {
            padding-left: 0;
            font-weight: 600;
        }

        .toc-list .toc-h2 {
            padding-left: 0.5rem;
        }

        .toc-list .toc-h3 {
            padding-left: 1rem;
            font-size: 0.8125rem;
        }

        .toc-list .toc-h4 {
            padding-left: 1.5rem;
            font-size: 0.75rem;
        }

        .toc-list .toc-h5 {
            padding-left: 2rem;
            font-size: 0.75rem;
        }

        .toc-sublist {
            list-style: none;
            padding: 0;
            margin: 0.25rem 0 0.5rem 0.75rem;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .toc-sublist.collapsed {
            max-height: 0;
            margin: 0;
        }

        .toc-sublist.expanded {
            max-height: 2000px;
        }

        .design-content {
            flex: 1;
            min-width: 0;
        }

        .markdown-body {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            line-height: 1.7;
        }

        .markdown-body h1,
        .markdown-body h2,
        .markdown-body h3,
        .markdown-body h4,
        .markdown-body h5 {
            scroll-margin-top: 100px; /* Offset for sticky navbar */
        }

        .markdown-body h1 {
            font-size: 2.5rem;
            margin-top: 0;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border);
            color: var(--text);
        }

        .markdown-body h2 {
            font-size: 2rem;
            margin-top: 2.5rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
            color: var(--text);
        }

        .markdown-body h3 {
            font-size: 1.5rem;
            margin-top: 2rem;
            margin-bottom: 0.75rem;
            color: var(--text);
        }

        .markdown-body h4 {
            font-size: 1.25rem;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        .markdown-body h5 {
            font-size: 1.125rem;
            margin-top: 1.25rem;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        .markdown-body p {
            margin-bottom: 1rem;
            color: var(--text);
        }

        .markdown-body ul,
        .markdown-body ol {
            margin-bottom: 1rem;
            padding-left: 2rem;
            color: var(--text);
        }

        .markdown-body li {
            margin-bottom: 0.5rem;
        }

        .markdown-body code {
            background: var(--bg);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
            color: var(--primary);
        }

        .markdown-body pre {
            background: var(--bg);
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            border: 1px solid var(--border);
            margin-bottom: 1rem;
        }

        .markdown-body pre code {
            background: transparent;
            padding: 0;
            color: var(--text);
        }

        .markdown-body blockquote {
            border-left: 4px solid var(--primary);
            padding-left: 1rem;
            margin-left: 0;
            margin-bottom: 1rem;
            color: var(--text-light);
            font-style: italic;
        }

        .markdown-body table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }

        .markdown-body table th,
        .markdown-body table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .markdown-body table th {
            background: var(--bg);
            font-weight: 600;
            color: var(--text);
        }

        .markdown-body a {
            color: var(--primary);
            text-decoration: none;
        }

        .markdown-body a:hover {
            text-decoration: underline;
        }

        .markdown-body strong {
            font-weight: 600;
            color: var(--text);
        }

        .markdown-body hr {
            border: none;
            border-top: 1px solid var(--border);
            margin: 2rem 0;
        }

        .loading {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-light);
        }

        .error {
            background: #fee2e2;
            color: #991b1b;
            padding: 1rem;
            border-radius: 8px;
            margin: 2rem 0;
            border-left: 4px solid var(--critical);
        }

        /* Custom scrollbar for TOC */
        .toc-sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .toc-sidebar::-webkit-scrollbar-track {
            background: var(--bg);
            border-radius: 3px;
        }

        .toc-sidebar::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .toc-sidebar::-webkit-scrollbar-thumb:hover {
            background: var(--text-light);
        }

        @media (max-width: 1024px) {
            .design-layout {
                flex-direction: column;
            }

            .toc-sidebar {
                width: 100%;
                position: relative;
                top: 0;
                max-height: 300px;
            }

            .toc-title {
                cursor: pointer;
                user-select: none;
            }

            .toc-list {
                max-height: 250px;
                overflow-y: auto;
            }
        }

        @media (max-width: 768px) {
            .toc-sidebar {
                max-height: 250px;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <img src="https://voxpupuli.org/static/images/8bit-vox.png" alt="Voxpupuli Logo" class="nav-logo">
                <h1>Voxpupuli Module Manager</h1>
            </div>
            <div class="nav-links">
                <a href="index.html">Dashboard</a>
                <a href="trends.html">Trends</a>
                <a href="alerts.html">Alerts</a>
                <a href="reports.html">Reports</a>
                <a href="design.html" class="active">Design</a>
                <button class="btn-primary" onclick="window.location.href='index.html'; return false;">Transfer Module</button>
            </div>
            <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">â˜°</button>
        </div>
    </nav>

    <main class="main-content">
        <div class="dashboard-header">
            <div class="header-content">
                <h2>Product Requirements Document</h2>
                <p class="subtitle">Design specifications and requirements for the Voxpupuli Module Manager</p>
            </div>
        </div>

        <div class="design-layout">
            <aside class="toc-sidebar" id="toc-sidebar">
                <div class="toc-title">Table of Contents</div>
                <ul class="toc-list" id="toc-list">
                    <li class="loading">Loading...</li>
                </ul>
            </aside>
            
            <div class="design-content">
                <div id="content-container">
                    <div class="loading">Loading design document...</div>
                </div>
            </div>
        </div>
    </main>

    <script>
        function buildTOCFromDOM() {
            // Get headings from the rendered DOM
            const headings = document.querySelectorAll('.markdown-body h1, .markdown-body h2, .markdown-body h3, .markdown-body h4, .markdown-body h5');
            
            return Array.from(headings).map(heading => {
                const level = parseInt(heading.tagName.charAt(1));
                const text = heading.textContent.trim();
                let id = heading.id;
                
                // If no ID exists, generate one (shouldn't happen with marked.js headerIds, but just in case)
                if (!id) {
                    id = text.toLowerCase()
                        .replace(/[^\w\s-]/g, '')
                        .replace(/\s+/g, '-')
                        .replace(/-+/g, '-')
                        .replace(/^-|-$/g, '');
                    heading.id = id;
                }
                
                return { level, text, id };
            });
        }

        function buildTOCStructure(headings) {
            // Build hierarchical structure
            const structure = [];
            const stack = []; // Stack to track parent sections
            
            headings.forEach(heading => {
                // Pop stack until we find a parent at a lower level
                while (stack.length > 0 && stack[stack.length - 1].level >= heading.level) {
                    stack.pop();
                }
                
                const node = {
                    ...heading,
                    children: []
                };
                
                if (stack.length === 0) {
                    // Top-level item
                    structure.push(node);
                } else {
                    // Child of the last item in stack
                    stack[stack.length - 1].children.push(node);
                }
                
                // Push this node onto the stack
                stack.push(node);
            });
            
            return structure;
        }

        function renderTOCItem(item, depth = 0) {
            const indentClass = `toc-h${item.level}`;
            const hasChildren = item.children && item.children.length > 0;
            
            let html = `
                <li>
                    <div class="toc-item">
            `;
            
            // Add toggle button if item has children
            if (hasChildren) {
                html += `
                    <button class="toc-toggle collapsed" aria-label="Toggle section"></button>
                `;
            } else {
                html += `<span style="width: 16px; flex-shrink: 0;"></span>`;
            }
            
            html += `
                        <a href="#${item.id}" class="${indentClass}" data-id="${item.id}">
                            ${item.text}
                        </a>
                    </div>
            `;
            
            // Add sublist if item has children
            if (hasChildren) {
                html += `<ul class="toc-sublist collapsed">`;
                item.children.forEach(child => {
                    html += renderTOCItem(child, depth + 1);
                });
                html += `</ul>`;
            }
            
            html += `</li>`;
            return html;
        }

        function renderTOC(headings) {
            const tocList = document.getElementById('toc-list');
            if (!headings || headings.length === 0) {
                tocList.innerHTML = '<li>No headings found</li>';
                return;
            }
            
            // Build hierarchical structure
            const structure = buildTOCStructure(headings);
            
            // Render HTML
            tocList.innerHTML = structure.map(item => renderTOCItem(item)).join('');
            
            // Add click handlers for smooth scrolling
            tocList.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const id = link.getAttribute('href').substring(1);
                    const element = document.getElementById(id);
                    if (element) {
                        element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });
            });
            
            // Add toggle handlers for expand/collapse
            tocList.querySelectorAll('.toc-toggle').forEach(toggle => {
                toggle.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const listItem = toggle.closest('li');
                    const sublist = listItem.querySelector('.toc-sublist');
                    
                    if (sublist) {
                        const isExpanded = sublist.classList.contains('expanded');
                        
                        if (isExpanded) {
                            sublist.classList.remove('expanded');
                            sublist.classList.add('collapsed');
                            toggle.classList.remove('expanded');
                            toggle.classList.add('collapsed');
                        } else {
                            sublist.classList.remove('collapsed');
                            sublist.classList.add('expanded');
                            toggle.classList.remove('collapsed');
                            toggle.classList.add('expanded');
                        }
                    }
                });
            });
        }

        function highlightActiveSection() {
            const headings = document.querySelectorAll('.markdown-body h1, .markdown-body h2, .markdown-body h3, .markdown-body h4');
            const tocLinks = document.querySelectorAll('#toc-list a');
            
            if (headings.length === 0 || tocLinks.length === 0) return;
            
            // Find the current section based on scroll position
            let currentHeading = null;
            const scrollPosition = window.scrollY + 120; // Offset for navbar
            
            headings.forEach(heading => {
                const headingTop = heading.offsetTop;
                if (headingTop <= scrollPosition) {
                    currentHeading = heading;
                }
            });
            
            // Update active state
            tocLinks.forEach(link => {
                link.classList.remove('active');
                if (currentHeading && link.getAttribute('href') === `#${currentHeading.id}`) {
                    link.classList.add('active');
                }
            });
        }

        async function loadPRD() {
            try {
                const response = await fetch('docs/PRD.md');
                if (!response.ok) {
                    throw new Error('Failed to load PRD.md');
                }
                const markdown = await response.text();
                
                // Configure marked options
                marked.setOptions({
                    breaks: true,
                    gfm: true,
                    headerIds: true,
                    mangle: false
                });

                // Convert markdown to HTML
                const html = marked.parse(markdown);
                
                // Update container with rendered HTML
                const container = document.getElementById('content-container');
                container.innerHTML = `<div class="markdown-body">${html}</div>`;
                
                // Build TOC from rendered DOM (after HTML is inserted) to match actual IDs
                setTimeout(() => {
                    const headings = buildTOCFromDOM();
                    renderTOC(headings);
                    
                    // Initialize active section highlighting
                    highlightActiveSection();
                }, 100);
                
            } catch (error) {
                const container = document.getElementById('content-container');
                const tocList = document.getElementById('toc-list');
                container.innerHTML = `
                    <div class="error">
                        <strong>Error loading document:</strong> ${error.message}
                    </div>
                `;
                tocList.innerHTML = '<li class="error">Unable to load TOC</li>';
            }
        }

        function toggleMobileMenu() {
            const navLinks = document.querySelector('.nav-links');
            navLinks.style.display = navLinks.style.display === 'flex' ? 'none' : 'flex';
        }

        // Load PRD on page load
        loadPRD();
        
        // Update active section on scroll
        let scrollTimeout;
        window.addEventListener('scroll', () => {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(highlightActiveSection, 100);
        });
    </script>
</body>
</html>
